---
title: "Vota Unicamp"
output: html_document
---

# Introdução

  A um pouco mais de um mês estudantes impulsionados por problemas que as universidades estaduais paulistas (USP, UNESP e UNICAMP) enfrentam, seja ele, má administração, corte financeiros, permanência estudantil, entraram em greve para reinvindicar suas pautas.

  O país, hoje, vive uma crise, a qual gerou inúmeros cortes, inclusive na educação. 
Estes cortes na educação, em específico nas universidades, geraram revoltas dos estudantes, o que impulsinou o movimento grevista dos alunos dentro das três maiores universidades do Brasil, USP, UNESP e UNICAMP. 
  Na UNICAMP, apesar de existir um movimento geral, cada instituto tem uma certa autonomia sobre as salas de aulas, e matérias ministradas por eles. Perante a este fato, a greve de alunos de cada instituto é decidida por meio de assembléias estudantis, organizada, normalmente, pelo centro acadêmico. Entretando, as tomadas de decisões baseadas nos resultados das assembléias são questionadas devido a sua falta representatividade. 
  Com o propósito de verificar, de fato, a opinião da classe estudantil, foi criado o site "https://votaunicamp.herokuapp.com/", no qual alunos matriculados na UNICAMP podem votar e até mesmo justificarem o voto se desejarem. 
  

```{r input, message=FALSE, echo = FALSE, warning=FALSE, message=FALSE}
##setup
if (Sys.info()['sysname'] == 'Darwin') Sys.setlocale(category = "LC_ALL", locale = "English_United States.1252")
library(ggplot2)
library(lattice)
#library(mapview)
library(sp)
library(stringr)
library(rvest)
library(googleVis)
library(leaflet)
library(plotly)
library(DT)
page = read_html('http://votaunicamp.herokuapp.com/prev_results/', encoding='UTF-8')
tbl = html_table(page)[[2]]
#head(tbl)
```

```{r format, echo=FALSE, warning=FALSE, message=FALSE}
##formatação dos dados
colnames(tbl)= c("Cursos", "Total", "Sim","Abstenções", "Não")
mytbl = data.frame(codigo=as.integer(str_extract(tbl$Curso, "^\\d+")),
                   nivel=NA,
                   curso=gsub("^(\\d+) - (.*)$", "\\2", tbl$Curso),
                   total=tbl$Total,
                   sim=as.integer(str_extract(tbl$Sim, "^\\d+")),
                   nao=as.integer(str_extract(tbl$Não, "^\\d+")),
                   abstencao=as.integer(str_extract(tbl$Abstenções, "^\\d+")))
nivel = str_extract(mytbl$curso, "(Dou|Mes)[a-z]+")
nivel[grepl("Mes", nivel)] = "Mestrado"
nivel[grepl("Dou", nivel)] = "Doutorado"
nivel[is.na(nivel)] = "Graduacao"
mytbl$nivel = nivel
rm(nivel)
mytbl$curso = gsub("(Mes|Dou).+ em (.*)$", "\\2", mytbl$curso)
head(mytbl)
```

# Análises

```{r votoinstitutos, echo=FALSE, warning=FALSE, message=FALSE}
## Separando os dados por institutos 
load("instituto_por_nome.rda")
colnames(instituto.por.numero) = c("Instituto", "Área", "Código", "NoMatriculados")
minhatab = subset(mytbl, nivel == "Graduacao")
minhatab = cbind(minhatab, c = rep(0, dim(minhatab)[1]), c = rep(0, dim(minhatab)[1]) )
for(i in 1:length(minhatab$codigo)) {
  for(j in 1:length(instituto.por.numero$Instituto) ){
    if(minhatab[i,1]==instituto.por.numero[j,3]){
      minhatab[i,8] = levels(instituto.por.numero[j,2])[instituto.por.numero[j,2]]
      minhatab[i,9] = levels(instituto.por.numero[j,1])[instituto.por.numero[j,1]]
    }
  }
}
colnames(minhatab) = c("Código","Nível","Curso","Total","Sim","Não","Abstenção","Área","Instituto")
nomesinstitutos = c("IMECC", "FEM", "FEF", "IA", "IEL", "IFCH", "IFGW", "IQ", "IB", "FEEC", "FEQ", "FE", "IE", "IC", "FEC", "FEAGRI", "FCM", "IG", "FEA", "PROFIS", "FENF", "FCF", "FCA", "FT", "FOP")
todosinstitutos = data.frame(matrix(nrow=25, ncol=4))
for(i in 1:length(minhatab$Código))
{ todosinstitutos[i,1] = sum(minhatab[which(minhatab[,9]== nomesinstitutos[i]),]$Total)
  todosinstitutos[i,2] = sum(minhatab[which(minhatab[,9]== nomesinstitutos[i]),]$Sim)
  todosinstitutos[i,3] = sum(minhatab[which(minhatab[,9]== nomesinstitutos[i]),]$Não)
  todosinstitutos[i,4] = sum(minhatab[which(minhatab[,9]== nomesinstitutos[i]),]$Abstenção)
}

todosinstitutos = todosinstitutos[1:25,]
todosinstitutos = cbind(todosinstitutos, nomesinstitutos)
colnames(todosinstitutos) = c("Total", "Sim", "Não", "Abstenção", "Instituto")
rownames(todosinstitutos) = nomesinstitutos

```






## proporção por area
```{r proporção, echo=FALSE, warning=FALSE, message=FALSE }
#na tabela todosinstitutos, últimos - limeira(FCA, FT) e piracicaba(FOP)
prop =  data.frame(matrix(nrow = length(todosinstitutos$Total), ncol = 3))
for(i in 1:dim(todosinstitutos)[1])
{ prop[i,] = c(100*todosinstitutos[i,2]/todosinstitutos[i,1], 100*todosinstitutos[i,3]/todosinstitutos[i,1], 100*todosinstitutos[i,4]/todosinstitutos[i,1])
}

rownames(prop) = c("IMECC", "FEM", "FEF", "IA", "IEL", "IFCH", "IFGW", "IQ", "IB", "FEEC", "FEQ", "FE", "IE", "IC", "FEC", "FEAGRI", "FCM", "IG", "FEA", "PROFIS", "FENF", "FCF","FCA", "FT","FOP")
colnames(prop) = c("SIM", "NÂO", "ABSTENÇÂO")
prop[,1] = as.numeric(prop[,1])
prop[,2] = as.numeric(prop[,2])
prop[,3] = as.numeric(prop[,3])
prop = round(prop,2)
## Arrumar quando for 0
##proptotal = prop[-21,-3]
##library(d3heatmap)
##library(RColorBrewer)
##d3heatmap(porptotal, col=rev(brewer.pal(9, "BuGn")))

```



## Campus Campinas
```{r enderecos_campinas, echo=FALSE, warning=FALSE, message=FALSE}
#acrescentando alguns institutos
ends = read.table('institutos.tab', sep='\t', header=TRUE)
localizacao_faltantes = data.frame(matrix(nrow = 3, ncol = 3))
localizacao_faltantes[1,] = c("PROFIS", -22.8174, -47.06847)
localizacao_faltantes[2,] = c("FENF", -22.83080 , -47.06133)
localizacao_faltantes[3,] = c("FCF", -22.81770, -47.07084)
localizacao_faltantes[,2] = as.numeric(localizacao_faltantes[,2])
localizacao_faltantes[,3] = as.numeric(localizacao_faltantes[,3])
colnames(localizacao_faltantes) = c("instituto","lat","lon")
ends = rbind(ends,localizacao_faltantes)

#função para gerar o gráfico que serão add no mapa

fldr <- tempfile()
dir.create(fldr)

pop <- lapply(seq(length(todosinstitutos[1:22,1])), function(i) {
 if(todosinstitutos$Total[i]==0){return("Sem Votos")}
  
  dados <- data.frame(Tipo=c("Sim","Não","Abstenções"),Total=c(0,0,0))
  dados[1,2]<-todosinstitutos[i,2]
  dados[2,2]<-todosinstitutos[i,3]
  dados[3,2]<-todosinstitutos[i,4]
  
  p = ggplot(data = dados, aes(x=Tipo,y=Total, fill=Tipo))+ geom_bar(stat="identity")+
    ggtitle(rownames((todosinstitutos[i,])))+xlab("")+ theme(legend.position="none")+
    scale_x_discrete(limits=c("Sim", "Não", "Abstenções"))+
    geom_text(aes(label=Total), vjust=0.2,
              position = position_dodge(0.9), size=3.5)
  
  svg(filename = paste(fldr, "test.svg", sep = "/"), 
      width = 250 * 0.01334, height = 250 * 0.01334)
  print(p)
  dev.off()

  tst <- paste(readLines(paste(fldr, "test.svg", sep = "/")), collapse = "")

  return(tst)
})

##gerando o mapa

pal= colorQuantile("BuGn",prop[1:22,2],n=5)
map = leaflet()
map = addTiles(map)
map = addCircleMarkers(map, lat=ends$lat, lng=ends$lon, popup = pop, color = pal(prop[1:22,2]), opacity = 1)
map
```



## Campus Limeira

```{r enderecos_limeira, echo=FALSE, warning=FALSE, message=FALSE}
#criando a localização de limeira
endlim = data.frame(matrix(nrow = 2, ncol = 3))
endlim[1,] = c("FCA", -22.55385, -47.42841)
endlim[2,] = c( "FT", -22.56201, -47.42397)
colnames(endlim) = c("instituto", "lat", "lon")
endlim[,2] = as.numeric(endlim[,2])
endlim[,3] = as.numeric(endlim[,3])
#institutoslim = data.frame(matrix(nrow = 2, ncol = 5))
institutoslim = todosinstitutos[c(23,24),]

##função para gerar os gráficos que serão add no mapa
fldr <- tempfile()
dir.create(fldr)

pop <- lapply(seq(length(institutoslim$Total)), function(i) {
  
  if(institutoslim$Total[i]==0){return("Sem Votos")}
  
  dados <- data.frame(Tipo=c("Sim","Não","Abstenções"),Total=c(0,0,0))
  dados[1,2]<-institutoslim[i,2]
  dados[2,2]<-institutoslim[i,3]
  dados[3,2]<-institutoslim[i,4]
  p = ggplot(data = dados, aes(x=Tipo,y=Total, fill=Tipo))+ geom_bar(stat="identity")+
    ggtitle(rownames((institutoslim[i,])))+xlab("")+ theme(legend.position="none")+
    scale_x_discrete(limits=c("Sim", "Não", "Abstenções"))+
    geom_text(aes(label=Total), vjust=0.2,
              position = position_dodge(0.9), size=3.5)
   
  
  svg(filename = paste(fldr, "test.svg", sep = "/"), 
      width = 250 * 0.01334, height = 250 * 0.01334)
   
   print(p)
   dev.off()
  

  tst <- paste(readLines(paste(fldr, "test.svg", sep = "/")), collapse = "")

  return(tst)
  
})

##gerando o mapa

map = leaflet()
map = addTiles(map)
map = addCircleMarkers(map, lat=endlim$lat, lng=endlim$lon, popup = pop)
map
```



## Campus Piracicaba

```{r enderecos_pira, echo=FALSE, warning=FALSE, message=FALSE}

endpira = data.frame(matrix(nrow = 1, ncol = 3))
endpira[1,] = c("FOP", -22.70154, -47.64767)
colnames(endpira) = c("instituto", "lat", "lon")
endpira[,2] = as.numeric(endpira[,2])
endpira[,3] = as.numeric(endpira[,3])

institutospira = todosinstitutos[25,]
# função para gerar os gráficos que serão add no mapa
fldr <- tempfile()
dir.create(fldr)

pop <- lapply(seq(length(institutospira$Total)), function(i) {
  if(todosinstitutos$Total[i]==0){return("Sem Votos")}
  
  dados <- data.frame(Tipo=c("Sim","Não","Abstenções"),Total=c(0,0,0))
  dados[1,2]<-institutospira[i,2]
  dados[2,2]<-institutospira[i,3]
  dados[3,2]<-institutospira[i,4]
  
  p = ggplot(data = dados, aes(x=Tipo,y=Total, fill=Tipo))+ geom_bar(stat="identity")+
    ggtitle(rownames((institutospira[i,])))+xlab("")+ theme(legend.position="none")+
    scale_x_discrete(limits=c("Sim", "Não", "Abstenções"))+
    geom_text(aes(label=Total), vjust=0.2,
              position = position_dodge(0.9), size=3.5)
  
  svg(filename = paste(fldr, "test.svg", sep = "/"), 
      width = 250 * 0.01334, height = 250 * 0.01334)
  print(p)
  dev.off()

  tst <- paste(readLines(paste(fldr, "test.svg", sep = "/")), collapse = "")

  return(tst)
})

## gerando o mapa
map = leaflet()
map = addTiles(map)
map = addCircleMarkers(map, lat=endpira$lat, lng=endpira$lon, popup = pop)
map
```






## Intervalos de Confiança

```{r stats, echo=FALSE, warning=FALSE, message=FALSE}
p = with(mytbl, nao/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
colnames(ics) = c("lower", "upper")
mytbl$p = p
mytbl = cbind(mytbl, ics)
```



## Tabelas interativa

```{r tabelainterativa, echo=FALSE, warning=FALSE, message=FALSE}

tabelafinal = minhatab[,c(8,9,3,4,5,6,7)]
tabelafinal = tabelafinal[,c(-8)]
colnames(tabelafinal) = c("Área","Instituto","Curso","Total","Sim","Não", "Abstenção")

datatable(tabelafinal, options = list(pageLength = 5))

```




##Tamanho da amostra
  
  Se quisermos encontrar o tamanho amostral $n$ necessário na Unicamp para que a probabilidade da nossa estimativa diferir absolutamente do verdadeiro valor por um erro escolhido $B = 0,03$ seja de $\alpha = 0.05$, chegariamos usando o que sabemos de probabilidade em

$$n = \dfrac{N}{4(N-1)D + 1}$$
  
onde $N$ é a quantidade total de alunos e $D = \frac{B^2}{z_{\alpha}^2}$, sendo $z_{\alpha} = `r round(qnorm(1-0.05),2)`$.


```{r n_total, echo=FALSE, warning=FALSE, message=FALSE}
n_amostral = function(N,B){
  round(N/(4*(N-1)*(B^2/qnorm(1-0.05)^2)+1),0)
}
nTotal = n_amostral(sum(instituto.por.numero$NoMatriculados),0.03)
```

Sendo assim, o tamanho amostral necessário para a Unicamp toda seria de $$`r round(nTotal,0)`$$
 
Se o interesse for um estudo por instituto, podemos ver na tabela abaixo qual o tamanho amostral necessário, com as mesmas condições anteriores, para cada um dos institutos da Unicamp

```{r tamanhoamostral, echo=FALSE, warning=FALSE, message=FALSE}
tam_amostral = data.frame(rep(0,25), row.names = nomesinstitutos)
colnames(tam_amostral) = "Tamanho Amostral"

for(i in 1:length(nomesinstitutos)){
  tam_amostral[i,] = n_amostral(sum(instituto.por.numero[which(instituto.por.numero$Instituto == nomesinstitutos[i]),]$NoMatriculados), 0.03)
}

library(knitr)
kable(tam_amostral)
```


## Comparações

```{r comparação de área, echo=FALSE, warning=FALSE, message=FALSE}
areas = data.frame(matrix(nrow=4, ncol=7))
nomesareas = c("Exatas", "Biológicas", "Humanas", "Profis")
rownames(areas) = nomesareas
colnames(areas) = c("Total", "Sim", "Não", "Abstenção", "PSim", "PNão", "PAbstenção")
for(i in 1:length(minhatab$Código))
{ areas[i,1] = sum(minhatab[which(minhatab[,8]== nomesareas[i]),]$Total)
  areas[i,2] = sum(minhatab[which(minhatab[,8]== nomesareas[i]),]$Sim)
  areas[i,3] = sum(minhatab[which(minhatab[,8]== nomesareas[i]),]$Não)
  areas[i,4] = sum(minhatab[which(minhatab[,8]== nomesareas[i]),]$Abstenção)
}
areas = areas[1:4,]
areas[,1] = as.numeric(areas[,1])
areas[,2] = as.numeric(areas[,2])
areas[,3] = as.numeric(areas[,3])

for(i in 1:length(areas$Total))
{ areas[i,5] = 100*areas[i,2]/areas[i,1]
  areas[i,6] = 100*areas[i,3]/areas[i,1]
  areas[i,7] = 100*areas[i,4]/areas[i,1]
}
areas[,5] = as.numeric(areas[,5])
areas[,6] = as.numeric(areas[,6])
areas[,7] = as.numeric(areas[,7])
areas[,c(5,6,7)] = round(areas[,c(5,6,7)],2)

p <- plot_ly( x =nomesareas , y =areas[1:3,5], name = "Sim", type = "bar")
p2 <- add_trace (p, x =nomesareas , y =areas[1:3,6], name = "Não", type = "bar" )
p3 <- add_trace(p2, x =nomesareas , y =areas[1:3,7], name = "Abstenção", type = "bar" )
p3
```


Existe um pensamento de que a opinião dos alunos de exatas difere dos alunos que não estão em um curso de exatas. Devido a isso, resolvemos separar nossos dados entre dois outros conjuntos de dados, um com os alunos que não são de exatas e outro somente com os alunos de exatas.

```{r exatas_naoexatas, echo=FALSE, warning=FALSE, message=FALSE }
NaoExatas = subset(mytbl, codigo == 26 | codigo == 25 | codigo == 64 | codigo == 23 | codigo == 22 | codigo == 6 |
                     codigo == 100 | codigo == 27 | codigo == 45 | codigo == 21 | codigo == 63 | codigo == 58 |
                     codigo == 46 | codigo == 15 | codigo == 107 | codigo == 14 |
                     codigo == 109 | codigo == 110 | codigo == 17 | codigo == 47 |
                     codigo == 16 | codigo == 44 | codigo == 75 | codigo == 30 | codigo == 54 | codigo == 55 |
                     codigo == 19 | codigo == 7 | codigo == 57 | codigo == 56 | codigo == 18 | codigo == 20 | codigo == 38)


Exatas = subset(mytbl, codigo != 26 & codigo != 25 & codigo != 64 & codigo != 23 & codigo != 22 & codigo != 6 &
                   codigo != 100 & codigo != 27 & codigo != 45 & codigo != 21 & codigo != 63 & codigo != 58 &
                     codigo != 46 & codigo != 15 & codigo != 107 & codigo != 14 &
                     codigo != 109 & codigo != 110 & codigo != 17 & codigo != 47 &
                     codigo != 16 & codigo != 44 & codigo != 75 & codigo != 30 & codigo != 54 & codigo != 55 &
                     codigo != 19 & codigo != 7 & codigo != 57 & codigo != 56 & codigo != 18 & codigo != 20 & codigo != 38)
```

Podemos ver que de fato as proporções são diferentes: 

```{r prop_exatas_naoexatas, echo=FALSE, warning=FALSE, message=FALSE}
props = c(p_NaoExatas = sum(NaoExatas$nao)/sum(NaoExatas$total),
p_Exatas = sum(Exatas$nao)/sum(Exatas$total))
names(props) = c("Não Exatas", "Exatas")
props
```

  Mas precisamos formalizar isso, usando um teste de hipótese, onde temos como hipótese nula "As proporções são iguais" e hipótese alternativa "As proporções são diferentes". O nível de significância escolhido será de $\alpha = 0.01$. Temos então o seguinte teste:

```{r teste_dif_exatas}
x = c(rep(1,sum(Exatas$nao)), rep(0,sum(Exatas$total)-sum(Exatas$nao)))
y = c(rep(1,sum(NaoExatas$nao)), rep(0,sum(NaoExatas$total)-sum(NaoExatas$nao)))

(teste_dif_exatas_nao_exatas = t.test(x,y))
```

Como temos um valor-p muito baixo, ou seja, menor que o nível de significância escolhido, rejeitamos a hipótese de que as proporções são iguais, confirmando assim o que já era esperado anteriormente. 




## Testes de hipótese

Foi realizado testes para a igualdade de proporção de votos **contra** para todos pares de cursos do banco de dados, utilizando como critério os intervalos de confiança de 95% para a proporção em cada curso. Pares de cursos que não foi encontrada interseção significam que, com 95% de certeza, estes pares tem opiniões diferentes em relação à greve: as proporções têm diferenças significativas, mostrando assim uma mentalidade ortodoxa entre os pares selecionados.


Devido à escassez de dados para cada curso, se o teste para diferença de proporção foi significativo, significa que a diferença entre as proprções destes pares foi grande.

```{r hypoteses, echo=FALSE, warning=FALSE, message=FALSE}
a=1
cursos = matrix(nrow=100, ncol=2)
for (i in (1:(dim(mytbl)[1]-1))){
  for(j in ((i+1):(dim(mytbl)[1]))){
    if(mytbl$upper[i]<mytbl$lower[j] | mytbl$lower[i]>mytbl$upper[j]){
        cursos[a, 1] = paste(mytbl$curso[i], mytbl$nivel[i], sep = " ")
        cursos[a, 2] = paste(mytbl$curso[j], mytbl$nivel[j], sep = " ")
        a = a + 1
    }
  }
}
cursos = cursos[1:58,]
```

Pode-se observar que existe uma polaridade forte na universidade:  `r dim(cursos)[1]` pares de cursos entre todos que foram testados para igualdade de proporção de votos **contra**, falharam, concluindo que estes pares de cursos tiveram opiniões divergentes em relação à greve.

Pode ser observado a forte presença de divergência entre cursos de áreas diferentes (biológicas, exatas e humanas), onde o conflito entre cursos de áreas iguais é bem mais fraco, porém ainda existem, com enfoque no curso "Licenciatura em Física", onde este curso, de exatas, conflituou com outros cursos de exatas com frequência considerável.


## contribuição de cada instituto
```{r porcentagem, echo=FALSE, warning=FALSE, message=FALSE}

matriculados = data.frame(rep(0,25), row.names = todosinstitutos$Nomes)

for(i in 1:length(todosinstitutos$Total)){
  matriculados[i,] = sum(instituto.por.numero[which(instituto.por.numero$Instituto == todosinstitutos$Instituto[i]),]$NoMatriculados)
}
propvot = data.frame(rep(0,25), rep(0,25))
propvot[,1] = todosinstitutos[,5]
for(i in 1:length(todosinstitutos$Instituto)){
  propvot[i,2] = round(100*todosinstitutos[i,1]/matriculados[i,1],2)
}
colnames(propvot) = c("Institutos", "porcentagem")
propvot = propvot[order(-propvot[,2], propvot[,1]),]

Instituto = propvot[,1]
Porcentagem = propvot[,2]
p <- plot_ly( x = Instituto, y = Porcentagem, name = "SF Zoo",type = "bar")
p
```


